<!DOCTYPE html>
<html>
<head>
    <title>Vector Initial Static Map</title>
    <meta name="viewport" content="width=device-width">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVuTX2xVdm8OScLSE8kVWr-jP4L2582mw&libraries=geometry&callback=initMap&v=beta"
            async defer>
    </script>

    <script>
        (function (exports) {
            var map;
            var curr_pos;
            var current_marker;
            var pos = { lat: '',lng: ''};

            var directionsService;
            var directionsRenderer;

            function initMap() {
               displayMap();
            }

            function displayMap() {
              map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 51.503399, lng: -0.119519 },
                    zoom: 17,
                    heading: 320,
                    tilt: 50,
                    mapId: "7c913e398bf72d2d",
                    disableDefaultUI: true,

                });
                getLocation();
            }

            function getLocation(){

                if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                    curr_pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        };

                        pos.lat = curr_pos.lat;
                        pos.lng = curr_pos.lng;

                        console.log("--->",curr_pos)

                        var marker = new google.maps.Marker({position:curr_pos
                        });
                        marker.setMap(map);
                        map.setCenter(curr_pos);
                        map.setZoom(15);
                        map.setTilt(25);

                        current_marker = marker
                    });

                }

                setTimeout(getDirection,2000)

            }

            function getDirection() {

                directionsRenderer = new google.maps.DirectionsRenderer();
                directionsService = new google.maps.DirectionsService();
                directionsRenderer.setMap(map);

                const start = new google.maps.LatLng(pos.lat,pos.lng);

               const end = "Golden Palms Rd,Geddalahalli,Bengaluru";

                directionsService.route({
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.DRIVING,
                }, (response, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                        directionsRenderer.setDirections(response);

                        console.log(response.routes[0].legs[0].steps)
                        console.log(response.routes[0].legs[0].start_location.position)
                        console.log(response.routes[0].legs[0].end_location)

                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                });



                setTimeout(animateMarker,5000)
            }



            function animateMarker() {

                var targetPosition = null;
                var isAnimating = false;
                var animationDuration = 1000; // Duration of the animation in milliseconds (adjust as needed)

                 function goToPoint() {

                    var lastBearing = 0;
                    if (!targetPosition || isAnimating) return;

                    isAnimating = true;
                    var currentPosition = curr_pos;

                    var distance = google.maps.geometry.spherical.computeDistanceBetween(currentPosition, targetPosition);
                    var bearing = google.maps.geometry.spherical.computeHeading(currentPosition, targetPosition);
                     


                    var startTime = Date.now();
                    var endTime = startTime + animationDuration;

                    var easingFactor = 0.1;
                    var newBearing = lastBearing + (bearing - lastBearing) * easingFactor;
                //    map.setHeading(newBearing)
                    lastBearing = newBearing;
                //    map.setZoom(20);
                //    map.setTilt(270)



                    var animationInterval = setInterval(function() {
                        var elapsed = Date.now() - startTime;
                        if (elapsed > animationDuration) {
                            clearInterval(animationInterval);
                            current_marker.setPosition(targetPosition);
                            curr_pos = targetPosition;
                            isAnimating = false;

                            return;
                        }

                        var t = elapsed / animationDuration; // Interpolation factor (0 to 1)
                        var interpolatedPosition = google.maps.geometry.spherical.interpolate(
                            curr_pos,
                            targetPosition,
                            t
                        );
                        current_marker.setPosition(interpolatedPosition);
                        updateCameraPosition(current_marker.getPosition(),bearing);
                       // map.panTo(current_marker.getPosition());

                    }, 150); // Adjust interval for smoother animation (e.g., 20ms)
                }

                 function updateCameraPosition(position, heading) {
                    // Calculate the offset position behind the marker
                    const offsetDistance = 0.5; // Define how far behind the camera should be
                    const headingRad = (heading + 180) * Math.PI / 180; // Reverse the heading to get behind the marker
                    const offsetLat = position.lat() + (Math.sin(headingRad) * offsetDistance / 111111); // 111111 meters per degree latitude
                    const offsetLng = position.lng() + (Math.cos(headingRad) * offsetDistance / (111111 * Math.cos(position.lat() * Math.PI / 180))); // Adjust for longitude

                    const cameraPosition = new google.maps.LatLng(offsetLat, offsetLng);

                    // Set the map's center to the calculated position
                    map.setCenter(cameraPosition);
                    map.setHeading(heading); // Rotate the map to match the user's heading
                    map.setZoom(20);
                    map.setTilt(30); // Optional: Adjust tilt for a better following view
                }

                // Callback to update the target location
                function updateLocation(){
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                targetPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                };

                                goToPoint();

                            });
                }
                }

                setInterval(updateLocation,1000)

            }


            exports.initMap = initMap;
        })((this.window = this.window || {}));
    </script>

    <style>
        html,
        body,
        .container {
            height: 100%;
            margin: 0;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
        }

        .map {
            flex: 1;
            height: 100%;
        }

        .custom-map-control-container {
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
<div class="container">
    <div id="map" class="map"></div>
</div>
</body>

</html>
